---
title: 浏览器回流(reflow)重绘(repaint)
tags:
- 浏览器
- 回流(reflow)
- 重绘(repaint)
desc: 浏览器回流重绘详细介绍
layout: post
---

## 网页生成过程
1. HTML 被 HTML 解析器解析成 DOM 树，CSS 被 CSS 解析器解析成 CSSOM 树
2. 结合 DOM 树和 CSSOM 树，生成渲染树(Render Tree)
3. 回流(Layout)：根据生成的渲染树，进行回流(Layout)，得到节点的几何信息(位置，大小)
4. 重绘(Painting)：根据渲染树以及回流得到的几何信息，得到节点的绝对像素
5. Display：将像素发送给 GPU，展示在页面上。（这一步还有很多内容，比如在 GPU 将多个合成层合并为同一个层，并展示在页面中。而 CSS3 硬件加速的原理则是新建合成层)
<!-- more -->
## 回流(reflow)
#### 概念
当 DOM 的变化影响了元素的几何信息(DOM 对象的位置和尺寸大小)，浏览器需要重新计算元素的几何属性，将其安放在界面中的正确位置，这个过程叫回流

#### 引起回流的常见属性和方法
任何会改变元素几何信息(元素的位置和尺寸大小)的操作，都会触发回流
- 添加或删除可见的 DOM 元素
- 元素的位置发生变化
- 元素尺寸发生变化(外边距、内边距、边框大小、高度和宽度等)
- 内容发生变化，比如文本变化或被另一个不同尺寸的图片所替代
- 页面初次渲染(无法避免)
- 浏览器窗口尺寸变化

## 重绘(repaint)
#### 概念
当一个元素的外观发生改变，但没有改变布局，重新把元素外观绘制出来的过程，叫做重绘

#### 引起重绘的常见属性和方法
- 回流(reflow)必定会引起重绘(repaint)，重绘不一定引起回流
- 背景色、颜色、字体改变(字体大小发生变化时，会出发回流)

## 浏览器优化机制
由于每次回流或重绘都会造成额外的计算消耗，因此大多数浏览器都会通过队列化修改并批量执行来优化该过程。浏览器会将修改操作放入到队列里，直到过了一段时间或者操作达到了一个阈值，才清空队列。但是**当你执行获取布局信息的操作的时候，会强制队列刷新**

## 优化建议
1. `offsetTop/Left/Width/Height`, `scrollTop/Left/Width/Height/`, `clientTop/Left/Width/Height`, `getComputedStyle`, `getBoundingClientRect`这些属性和方法都需要返回最新的布局信息，因此浏览器不得不清空队列，触发回流重绘来返回正确的值。因此我们最好避免使用这些属性，或者将值缓存起来。
2. 分离读写操作，样式集中改变
3. 离线改变dom
    - 隐藏要操作的dom
    - 使用 `DocumentFragment` 创建一个 dom 文档片段
    - 复制节点，在副本上操作，然后替换它
4. position 属性设置为 absolute 或 fixed
5. CSS3 硬件加速(GPU 加速)

*Ref*
- [你真的了解回流和重绘吗](https://juejin.im/post/5c0f104551882509a7683d63)
- [浏览器重绘(repaint)重排(reflow)与优化[浏览器机制]](https://juejin.im/post/5c15f797f265da61141c7f86)
